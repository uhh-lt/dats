services:
  postgres:
    volumes:
      - "postgres_data:/var/lib/postgresql/data"
    ports:
      - "${POSTGRES_EXPOSED?postgres-exposed-required!}:5432"

  redis:
    volumes:
      - "redis_data:/var/lib/redis/data"
    ports:
      - "${REDIS_EXPOSED?redis-exposed-required!}:6379"

  weaviate:
    volumes:
      - "weaviate_data:/var/lib/weaviate"
    ports:
      - "${WEAVIATE_EXPOSED?weaviate-exposed-required!}:8080"
      - "${WEAVIATE_GRPC_EXPOSED?weaviate-grpc-exposed-required!}:50051"

  weaviateapp:
    # https://github.com/Shah91n/WeaviateCluster
    image: weaviateclusterapp:latest
    ports:
      - "${WEAVIATEAPP_EXPOSED?weaviateapp-exposed-required!}:8501"
    extra_hosts:
      - "localhost:host-gateway"
    profiles:
      - weaviate

  elasticsearch:
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "${ELASTICSEARCH_EXPOSED?elasticsearch-exposed-required!}:9200"

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.1
    environment:
      ELASTICSEARCH_URL: http://elasticsearch:9200
      ELASTICSEARCH_HOSTS: '["http://elasticsearch:9200"]'
    ports:
      - "${KIBANA_EXPOSED?kibana-exposed-required!}:5601"
    networks:
      - dats_network
    depends_on:
      elasticsearch:
        condition: service_healthy
        restart: true

  lighttpd:
    image: sebp/lighttpd
    volumes:
      - ./backend_repo:/var/www/localhost/htdocs
    tty: true
    ports:
      - "${CONTENT_SERVER_EXPOSED?content-server-exposed-required!}:80"
    networks:
      - dats_network

  rq-cpu-worker:
    volumes:
      - ../backend/src:/dats_code/src

  rq-gpu-worker:
    volumes:
      - ../backend/src:/dats_code/src

  dats-backend-api:
    volumes:
      - ../backend/src:/dats_code/src

volumes:
  redis_data:
    driver: local
  postgres_data:
    driver: local
  elasticsearch_data:
    driver: local
  weaviate_data:
    driver: local
